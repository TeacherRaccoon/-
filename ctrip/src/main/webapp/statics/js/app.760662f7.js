"use strict";!function(e,t){function a(e){function t(){var e=this;a.each(function(t,a){t[0]==e?(t.addClass("hot_selected"),i[a].style.display=""):(t.removeClass("hot_selected"),i[a].style.display="none")})}var a=e.find("span"),i=e.find(".tab_cont");if(a.length){for(var r=30,o=0,n=a.length;o<n;o++)r+=a[o].parentNode.offsetWidth;var s=e.find("div").first();s[0]&&r>278&&s.css("width",r+"px"),a.bind("mousedown",t),t.apply(a[0])}}t.setupAddress=function(t,i,r,o){var n=e(t),s={name:i,isFocusNext:!1,isAutoCorrect:!1,offset:5,charset:"UTF8",jsonpFilter:"//flights.ctrip.com/international/search/api/poi/search?callback=cQuery.jsonpResponse=&key=${key}&channel=1&mode=1&f=1",delay:150};r?(s.onlyFilter=!0,s.source={}):(s.jsonpSource="//webresource.c-ctrip.com/code/cquery/resource/address/flight/fuzzy_start_poi_timezone_UTF8.js??CR_2016_04_26_00_00_00",s.template={suggestionStyle:"",suggestionInit:a,suggestion:'                    <div class="poi_address">                        <div class="poi_address_tit"><a class="close" href="javascript:;" onmousedown="this.focus();">&times;</a>支持中文/拼音/简拼输入</div>                        <ol class="tab_menu">                            {{enum(key) data}}                                <li><span>${key}</span></li>                            {{/enum}}                        </ol>                        {{enum(key,arr) data}}                            <div class="tab_cont">                                {{if arr.length}}                                    <ul class="poi_address_list">                                        {{each arr}}                                            <li><a data="${data}" href="javascript:void(0);">${display}</a></li>                                        {{/each}}                                    </ul>                                {{else}}                                    {{enum(k,v) arr}}                                        <strong class="tit">${k}</strong>                                        <ul class="poi_address_list">                                            {{each v}}                                                <li><a data="${data}" href="javascript:void(0);">${display}</a></li>                                            {{/each}}                                        </ul>                                    {{/enum}}                                {{/if}}                            </div>                        {{/enum}}                    </div>                '}),o&&(s.template=s.template||{},s.template.filter='                <div class="poi_suggest">                    <table cellspacing="0" cellpadding="2">                    {{if length < 1  || isUseLastData}}                    <tbody>                        <tr>                            <th class="error">对不起，暂不支持该地点</th>                        </tr>                    </tbody>                    {{/if}}                    {{if exname}}                    <tbody>                        <tr>                            <th>您要找的是不是 <b>${exname}</b></th>                        </tr>                    </tbody>                    {{/if}}                    {{if length > 0}}                    {{enum(k, v) result}}                    <tbody>                        {{each(i, val, len) v}}                        <tr>                            <td class="{{if i===0}}icon_${k} {{/if}}{{if (k===\'scenic\' || k===\'province\') && !val.isNearBy}}item_scenic {{/if}}{{if val.isNearBy}}airport_nearby {{/if}}{{if k===\'city\' && !val.hasAirportCity && !val.isNearBy}}no_airport{{/if}}"{{if val.value || val.isCountry}} data="${val.value || val.country}"{{/if}}{{if val.log}} log="${val.log}"{{/if}}>${getPoiItemName(i, k, val)}</td>                        </tr>                        {{/each}}                    </tbody>                    {{/enum}}                    {{/if}}                    </table>                </div>            ');var c=n.regMod("address","1.0",s);return c.method("bind","userinput",function(e,t){if("keydown"===t.eventType||"filterMousedown"===t.eventType){var a=(t.target.getAttribute("log")||"|").split("|");({input:t.value,use:t.autoCorrectValue,type:a[0],menuname:a[1]})}}),c},"undefined"==typeof window.__bfi&&(window.__bfi=[])}(cQuery,window.AppData||(window.AppData={})),function($,_,AppData){function trackData(e){"undefined"==typeof window.__bfi&&(window.__bfi=[]);var t=JSON.stringify(trackJson[e]);window.__bfi.push(["_tracklog",g_page_keys[e],t])}function resetInit(){function e(e){categoryMap[e.categoryCode]=e.categoryName}getAllCategory(function(t){_.each(t.allDomesticAreaList,e),_.each(t.allIntlAreaList,e),_.each(t.allThemeList,e),renderArrivalMenu(t)}),AppData.selectDateInfo=[],AppData.searchData={inputDepartureCity:window.departCity,inputDepartureCityName:window.departCityName,travelType:"ONEWAY",departStringDate:"任何时间"},AppData.inputArrivalCitiesMap={themes:[],cities:[],areas:[],filter:{}},AppData.address=AppData.address||{depart:{code:window.departCity,name:window.departCityName},arrival:[]},$("#homeCity").val(window.departCityName?window.departCityName:"");var t=$arrivalInput;t.inputTag({tags:AppData.address.arrival,isTagSame:function(e,a){var i=e.code===a.code&&e.category===a.category;return i&&t.val(""),i},generateTag:function(e,t){var a="themes"===e.category?e.name:e.name.slice(0,5);return'<li class="tag tag_goal">'+a+'<i class="close">&times;</i></li>'},afterInit:function(e){AppData.inputTag=e,e.$tagContainer.on("click",function(e){e.stopPropagation()})},capacity:4,containerClass:"tag_box",tagClass:"tag_goal",closeIconClass:"close"}).on("itemadd",function(e,a,i){t.css({"padding-left":a.$tagContainer.width()}),t.val(""),a.tags.length>1?t.removeAttr("placeholder"):t.attr("placeholder","可输入多个哦")}).on("capacityoverflow",function(e,a){t.val(""),showTip("最多可输入四个"),trackJson[AppData.route].timetips++,trackData(AppData.route)}).on("capacityfill",function(e,t){}).on("itemremove",function(e,a){t.css({"padding-left":a.$tagContainer.width()}),a.tags.length||t.val("全世界")})}function getAllCategory(e){var t=window.allCategoryDetails;t?e(t):cQuery.jsonp("fuzzy/get-all-category-details",{charset:"utf-8",onload:e})}function resetCompareSize(){var e=$(window).height();AppData.$compareListWrapper.css({height:e-175}).customScrollbar("resize",!0)}function routeCheck(){return Backbone.history.prevFragment&&(routeActions[Backbone.history.prevFragment+"Out"]||$.noop)(),!AppData.cityData||"compare"!==Backbone.history.prevFragment||(toggleCompare(compareCities.length?"show":"hide"),!1)}function getCityInit(){var e=searchRequestModel&&searchRequestModel.inputDepartureCity?searchRequestModel.inputDepartureCity:window.departCity,t=searchRequestModel&&searchRequestModel.travelType?searchRequestModel.travelType:"ONEWAY";AppData.searchData.travelType=t,selectCityByName(e,function(){searchRequestModel&&(AppData.address.depart.code=searchRequestModel.inputDepartureCity||defaultCity.code,AppData.address.depart.name=searchRequestModel.inputDepartureCityName||defaultCity.name);var e=AppData.address.depart;$(".public_noresult").hide(),$(".citi_list_tit").text("为您展示"+e.name+"飞往全世界的热门航班").show(),$compareTip.text(e.name+"出发到中意的城市对比"),AppData.searchData.inputDepartureCity=e.code,AppData.searchData.inputDepartureCityName=e.name,renderCityList(!0,{inputDepartureCity:e.code}),$("#homeCity").val(e.name?e.name:""),selectTravelType(t)})}function init(){setupTopBarBG(),setupDatePicker(),setupDepartAddress(),setupArrival(),setupSlider(),interactWithFilters(),interactWithCityItem(),interactWithCompareItem(),interactWithSideIcon(),setupUserCollection()}function getTravelType(){return AppData.searchData?AppData.searchData.travelType:"ONEWAY"}function getArgs(){var e=$(".search_form").find(".search_path_val").attr("data-select"),t=[];AppData.travalType=e;var a={inputDepartureCity:AppData.address.depart.code||window.departCity,inputDepartureCityName:AppData.address.depart.name||window.departCityName,travelType:e,departStringDate:$("#date").val()};if(AppData.selectDateInfo){for(var i=0;i<AppData.selectDateInfo.length;i++)t.push({startDate:AppData.selectDateInfo[i].from.toISOString(),endDate:AppData.selectDateInfo[i].to.toISOString()});a=_.extend({},a,{departDateRanges:t})}if("ONEWAY"===e)a.minDays=a.maxDays=-1;else{var r=$(".cus_days").find(".tag.selected").data("range");r&&(a.minDays=r[0],a.maxDays=r[1])}var o={themes:[],cities:[],areas:[]},n={themes:[],cities:[],areas:[],filter:{}};return AppData.address.arrival.length&&($.each(AppData.address.arrival,function(e,t){o[t.category].push(t.code),n[t.category].push(t.name)}),a.inputArrivalCities=o,selectArrival({inputArrivalCities:o,inputArrivalCitiesMap:n})),flags.shouldRenderThemeColor=1===o.themes.length,flags.shouldRenderThemeColor&&(flags.theme=o.themes[0]),a.inputArrivalCities=o,a.inputArrivalCitiesMap=n,AppData.inputArrivalCitiesMap=n,a}function fetchCityData(e){var t="PRICE_ASC";for(var a in AppData.citySort)AppData.citySort&&(t=(("totalPrice"==a?"price":"heat")+"_"+AppData.citySort[a]).toUpperCase());var i=_.extend({},e,{travelType:getTravelType(),sortingType:t,isIncludedTax:!0,city_offset:AppData.city_offset?AppData.city_offset:480});if(xhr&&4!=xhr.readyState&&xhr.abort(),$(".public_noresult").hide(),$(".citi_list_tit").show(),$loader.show(),xhr=$.ajax({url:"/fuzzy/search",type:"POST",data:JSON.stringify(i),dataType:"json",contentType:"application/json; charset=utf-8"}))return xhr.then(function(e){if(e){AppData.cityData=e,AppData.cloneCityData=e,e.noBigPic="search"===AppData.route,e.imageSetting=imageSetting,e.iconSetting=iconSetting,e.countryColorsSetting=countryColorsSetting;var t=Number.MAX_VALUE,a=0,i=!1,r=!1,o=!1;return $.each(e.fuzzyFlightList,function(n,s){s.preferLength="search"===AppData.route?7:8,s.flightResultList||(s.flightResultList=[]),$.each(s.flightResultList,function(n,s){s.totalPrice<t&&(t=s.totalPrice),s.totalPrice>a&&(a=s.totalPrice),"string"==typeof s.themes&&(s.themes=s.themes.split(",")),s.flightClass=s.flightClass||"D","D"===s.flightClass?i=!0:"I"===s.flightClass?r=!0:o=!0,"string"==typeof s.photoUrl&&(s.photoUrl=s.photoUrl.replace(/^https?:/,"")),s.linkUrl=processLink(s.flightClass,e.dCity,s.aCity,s.flightDetail.departDateString,s.flightDetail.returnDateString,getTravelType())})}),AppData.minPrice=t===Number.MAX_VALUE||null===t?"--":t,AppData.maxPrice=0===a?"--":a,AppData.showAreaFilter=!!(e.filterList&&e.filterList.length>1),e.fresh=!0,e}}).always(function(){$loader.hide()})}function selectCityByName(e,t){getCitySuggestion(encodeURI(e)).always(function(e){if("string"==typeof e&&((0,eval)(e),e=null),e=e||cQuery.jsonpResponse||defaultCity,e.Key===window.departCity.toUpperCase()){var a=e.Data[0];if(a){for(;5!==a.Type;)a=a.Datas[0];AppData.address.depart={name:a.Name,code:a.Code}}}else AppData.address.depart=e;t?t():null})}function getCitySuggestion(e){return e?$.getScript("//flights.ctrip.com/international/search/api/poi/search?callback=cQuery.jsonpResponse=&charset=utf-8&key="+e+"&channel=1&mode=1&f=1"):$.Deferred().resolve(defaultCity)}function renderCityList(e,t,a){e&&$cityListContainer.hide();var i=e?fetchCityData(t):$.Deferred().resolve((t.fresh=!1)||t),r=!1;return AppData.slider&&AppData.slider.freeze(),i.then(function(a){if(AppData.slider.unfreeze(),a.travelType=getTravelType(),e||2!==a.fuzzyFlightList.length||"userSearchResults"===a.fuzzyFlightList[0].categoryCode&&"allResult"===a.fuzzyFlightList[1].categoryCode&&(a.fuzzyFlightList[0].hideTitleBlock=a.fuzzyFlightList[1].hideGroup),e&&t.isSearchPage&&a.fuzzyFlightList.length){var i=a.fuzzyFlightList[0];"allResult"!==i.categoryCode&&("userSearchResults"!==i.categoryCode||i.flightResultList.length||$(".citi_list_tit").text("没有找到陛下指定城市，看看其他推荐城市吧").show(),i=a.fuzzyFlightList[1]),i&&(i.preferLength=i.flightResultList.length,i.hideTitleBlock=!0)}if(a.preferTheme=null,flags.shouldRenderThemeColor&&(a.preferTheme=iconSetting[flags.theme],flags.shouldRenderThemeColor=!1),e&&a.fuzzyFlightList&&a.fuzzyFlightList.length)for(var o=0;o<a.fuzzyFlightList.length;o++)if(a.fuzzyFlightList[o].flightResultList&&a.fuzzyFlightList[o].flightResultList.length)for(var n=0;n<a.fuzzyFlightList[o].flightResultList.length;n++)a.fuzzyFlightList[o].flightResultList[n].linkUrl+="#ctm_ref=fld_fz_hp_list_p";$cityListContainer.html(cityListRender(a)),addCollectedIcon(userCollection);var s={min:0,size:AppData.maxPrice-AppData.minPrice,max:AppData.maxPrice-AppData.minPrice};e&&($cityListContainer.show(),renderTags(a),$(".city_list li").each(function(e){var t=$(this).find("img.lazy-img"),a=t.data("src");if(a){var i=a.replace("fuzzy","fuzzyblur");AppData["lazyInstance"+e]&&AppData["lazyInstance"+e].destroy(),AppData["lazyInstance"+e]=t.Lazy({chainable:!1,bind:"event",defaultImage:i,placeholder:i,onError:function(e){}})}}),s.value=AppData.maxPrice-AppData.minPrice,$(".budget_filter .budget:first").html("<dfn>¥</dfn>"+AppData.minPrice),$(".budget_filter .budget:last").html("<dfn>¥</dfn>"+AppData.maxPrice)),AppData.slider.set(s),$areaFilter[AppData.showAreaFilter?"show":"hide"](),r=!a.fuzzyFlightList||0===a.fuzzyFlightList.length}).always(function(){r||!$cityListContainer.find("ul li").length?($(".citi_list_tit").hide(),$(".public_noresult").show(),r&&AppData.slider.freeze()):($(".public_noresult").hide(),AppData.slider.unfreeze())})}function addCollectedIcon(e){var t=AppData.cityData.fuzzyFlightList;_.each(e,function(e){if(t&&t.length)for(var a=0;a<t.length;a++)if(t[a].flightResultList&&t[a].flightResultList.length)for(var i=0;i<t[a].flightResultList.length;i++){var r=_.extend({},t[a].flightResultList[i]),o={departCityCode:AppData.address.depart.code||window.departCity,arriveCityCode:r.aCity,departDate:r.flightDetail.departDate,returnDate:r.flightDetail.returnDate,duration:r.flightDetail.duration};if(_.isEqual(_.pick(e,["departCityCode","arriveCityCode","departDate","returnDate","duration"]),o)){$(".city_list li").each(function(){$(this).data("sid")===a+","+i&&$(this).find(".ico_collection_h").removeClass("ico_collection_h").addClass("ico_collectioned")});break}}})}function renderTags(e){var t=_.template($("#tpl-tag-list").html())(e);$(".area_filter").html(t)}function renderArrivalMenu(e){var t=$(".search_filter"),a=_.template($("#tpl-arrival-menu").html());e?(e.allThemeList=e.allThemeList||[],e.allAreaList=e.allAreaList||[],e.allHotCityList=e.allHotCityList||[]):e={allThemeList:[],allAreaList:[],allHotCityList:[]},e.iconSetting=iconSetting,window.allCategoryDetails=e,t.html(a(e))}function filterCityList(e,t,a){function i(e,t){return AppData.inputArrivalCitiesMap=AppData.inputArrivalCitiesMap||{},AppData.inputArrivalCitiesMap.filter=AppData.inputArrivalCitiesMap.filter||{},a&&(AppData.inputArrivalCitiesMap.filter[a]=categoryMap[t.flightClass]),"all"===t.flightClass&&(AppData.inputArrivalCitiesMap.filter={}),manageSearchText(AppData.inputArrivalCitiesMap,e.dCityName),$.each(e.fuzzyFlightList,function(e,a){var i=!0;$.each(a.flightResultList,function(e,a){a.filterThemeAreaKeys=_.union(_.pluck(a.areaDetailList,"categoryCode"),_.pluck(a.themeDetailList,"categoryCode")),("D"===t.flightClass&&"中国"===a.aCountry||"I"===t.flightClass&&("中国"!==a.aCountry||~a.flightClass.indexOf("DI"))||"all"===t.flightClass||~a.filterThemeAreaKeys.indexOf(t.flightClass))&&a.totalPrice<=t.totalPrice?(a.hideByFilter=!1,i=!1):a.hideByFilter=!0}),a.hideGroup=i}),e}var r=AppData.cityData,o=AppData.cityFilter;if(r&&e&&("length"===e||o[e]!==t)){if(o[e]=t,"length"===e){var n=r.fuzzyFlightList[a];if(n.preferLength>=t)return;n.preferLength=t}else i(r,o);renderCityList(!1,r,!0)}}function fetchCompareData(e,t){return $.ajax({url:"/fuzzy/compare",type:"POST",data:JSON.stringify(_.extend({},AppData.searchData,e)),dataType:"json",contentType:"application/json; charset=utf-8"}).then(callbackTrip)}function callbackTrip(e){var t=e.endDate-e.startDate;return"ONEWAY"===getTravelType()?e=t>24192e5?groupCompare(e,"month"):groupCompare(e,"day"):(e=groupCompare(e,"days"),e.groupByDays=groupByDaysObj(e.compareCitys),e.groupByLows=groupByDaysLow(e),_.extend(e.compareCitys,e.groupByLows)),AppData.compareData=e,e}function groupCompare(e,t){t=t||"days";var a,i,r=e.roundtrip="days"===t;_.each(e.fuzzyFlightCompareModelList,function(o){i=o.flightPriceModelList,o.assembleForPage={},_.each(i,function(i){i.flightClass=o.flightClass,i.aCity=o.aCity;var n=i.flightDetail;switch(i.linkUrl=processLink(i.flightClass,e.dCity,i.aCity,n.departDateString,n.returnDateString,getTravelType()),r&&(i.returnDays=1+(n.returnDate-n.departDate)/864e5),t){case"days":a=i.returnDays;break;case"month":var s=n.departDateString.split("-");i.year=s[0],i.month=s[1],i.week=calcWeekIndexOfMonth(new Date(n.departDate),1)+1,a=s[0]+"."+s[1];break;case"week":a="";break;case"day":a=n.departDateString.split("-").join(".")}"month"!==t&&(o.assembleForPage[a]=i)}),"month"===t&&(o.assembleForPage=_.groupBy(i,function(e){return e.year+"."+e.month}))});var o={},n={},s=[];return _.each(e.fuzzyFlightCompareModelList,function(e){s=_.union(s,_.keys(e.assembleForPage))}),_.each(s,function(t){o[t]=[],_.each(e.fuzzyFlightCompareModelList,function(e){o[t].push(e.assembleForPage[t])})}),"month"===t?(_.each(o,function(e,t){var a=[],i=[],r={};_.each(e,function(e,t){a.push(_.min(e,function(e){if(e)return e.totalPrice})),r=_.groupBy(e,function(e){return e.week});var o={},n=0;_.each(r,function(e,t){n++,o["第"+t+"周"]=_.min(e,function(e){if(e)return e.totalPrice})}),i.push(o)}),o[t+"-week-min"]=i,o[t+"-month-min"]=a,n[t]=a}),_.each(o,function(e,t){var a=[];if(~t.indexOf("-month-min")){var i=[];_.each(e,function(e,t){i.push(e)});var r=_.min(i,function(e){if(e)return e.totalPrice});r.lowest=!0}~t.indexOf("-week-min")&&(_.each(e,function(e,t){a=_.union(a,_.keys(e))}),_.each(a,function(a){var i=[];_.each(e,function(e,r){i.push(e[a]),(!~a.indexOf("<br>")||a.indexOf("br")&&a.substring(0,7)===t.substring(0,7))&&(n[t+"-"+a]=i)})}))}),e.compareCitys=n):e.compareCitys=o,"day"===t&&_.each(e.compareCitys,function(e,t){var a=_.min(e,function(e){if(e)return e.totalPrice});a.lowest=!0}),e.groupType=t,e}function groupByDaysKey(e){var t=_.keys(e),a={},i=[[3,5],[6,8],[9,11],[12,15]];return _.each(i,function(e){var i=_.groupBy(t,function(t){var a=parseInt(t,10);if(a>=e[0]&&a<=e[1])return e[0]+"-"+e[1]});a=_.extend({},a,i)}),delete a.undefined,a}function groupByDaysObj(e){var t={},a=groupByDaysKey(e);return _.each(a,function(a,i){t[i]=[],_.each(a,function(a){t[i].push(e[a])})}),t}function groupByDaysLow(e){var t={};return _.each(e.groupByDays,function(a,i){t[i]=[],_.each(e.fuzzyFlightCompareModelList,function(e,r){var o=[];_.each(a,function(e){o.push(e[r])}),t[i].push(_.min(o,function(e){if(e)return e.totalPrice}))})}),_.each(t,function(e,t){var a=_.min(e,function(e){if(e)return e.totalPrice});a.lowest=!0}),t}function calcWeekIndexOfMonth(e,t){if(!(e instanceof Date))return-1;t=t||0;var a=e.getMonth(),i=e.getDate(),r=new Date(e.getFullYear(),a,1),o=r.getDay(),n=0,s=1;for((o>0||0===t)&&(s=7-o+t,r.setDate(s));r.getMonth()===a;){if(i<=s)return n;r.setDate(s),s+=7,n++}}function renderCompareList(e,t){AppData.$compareListWrapper&&AppData.$compareListWrapper.hide();var a=e?fetchCompareData(t,AppData.selectDateInfo):$.Deferred().resolve(t);a.then(function(e){AppData.$compareListContainer.html(AppData.compareListRender(e)),AppData.$compareListWrapper.show();var t=e.fuzzyFlightCompareModelList;t&&t.length&&(compareCities.length<t.length&&(compareCities=compareCities.concat(_.map(t.slice(compareCities.length),function(e){return e.suggested=!0,e})),AppData.compareCities=compareCities,$compareCitiesContainer.html(compareCitiesRender(AppData))),setTimeout(function(){AppData.$compareListWrapper.customScrollbar("resize",!0)},0))})}function addToCompareCities(e,t){var a,i=(""+e).split(","),r=AppData.cityData.fuzzyFlightList[i[0]].flightResultList[i[1]],o=_.pluck(AppData.compareCities,"aCity");return~o.indexOf(t)||(a=compareCities.length>=4)?a?"reachMax":"added":(compareWrapHidden=!1,compareCityCache[r.aCity]=e,compareCities.push(r),AppData.compareCities=compareCities,AppData.imageSetting=imageSetting,$compareCitiesContainer.html(compareCitiesRender(AppData)),showByCompareLength(compareCities.length),compareWrapHidden||toggleCompare("show"),$(".compare_expand_op .btn").removeClass("disabled"),!0)}function removeCompareCity(e){if(e===-1)compareCityCache={},compareCities=[];else{var t=compareCities.splice(e,1);compareCityCache[t[0].aCity]=void 0}AppData.compareCities=compareCities,compareCities.length||$compare.hasClass("compare_fixed_mini")||toggleCompare("clear"),$compareCitiesContainer.html(compareCitiesRender(AppData)),showByCompareLength(compareCities.length);var a=AppData.compareData=AppData.compareData||null;a&&(e===-1?(a.compareCitys={},a.fuzzyFlightCompareModelList=null):(_.each(a.compareCitys,function(t,a){t.splice(e,1)}),a.fuzzyFlightCompareModelList.splice(e,1)),renderCompareList(!1,a))}function showByCompareLength(e){$compare.find(".ico_compare").css("display","none"),$compare.find(".ico_compare"+e).css("display","block")}function toggleCompare(e){var t=$(".compare_tit").find(".txt"),a=$(".compare_expand_op");switch(e){case"hide":$compare.css("height","154px").removeClass("expand").addClass("compare_fixed_mini").find(".compare_bottom").hide();break;case"clear":$compare.css("height","48px").removeClass("expand"),a.find(".begin").addClass("disabled").show(),a.find(".collaspe").length&&a.find(".collaspe").removeClass("collaspe").addClass("clear").text("清空"),"compare"===AppData.route&&appRouter.navigate(Backbone.history.prevFragment,!0);break;case"show":t.text(AppData.searchData.inputDepartureCityName+"出发到中意的城市对比"),a.find(".begin").removeClass("disabled").show(),$compare.css("height","154px").removeClass("expand compare_fixed_mini").find(".compare_bottom").show(),a.find(".collaspe").length&&a.find(".collaspe").removeClass("collaspe").addClass("clear").text("清空");break;case"expand":t.text(AppData.searchData.inputDepartureCityName+"出发到中意的城市对比结果     "+AppData.searchData.departStringDate),a.find(".begin").hide().end().find(".clear").addClass("collaspe").removeClass("clear").text("收起"),$compare.css("height","100%").removeClass("compare_fixed_mini").addClass("expand").find(".compare_bottom").show();break;default:$compare.addClass("compare_fixed_mini").find(".compare_bottom").hide()}}function loadMoreCities(e){var t=AppData.cityData.fuzzyFlightList[e];t&&t.preferLength<t.flightResultList.length&&filterCityList("length",t.preferLength+8,e)}function getFormattedDateStr(e,t){function a(e){return e<10?"0"+e:e}return t?e.toISOString().slice(0,10):e.getFullYear()+"-"+a(e.getMonth()+1)+"-"+a(e.getDate())}function toggleFiltersSort(e){$(".filter_bar").find(".sliding_filter")[e]()}function interactWithFilters(){$(".filter_bar").on("change",".area_filter .radio",function(){var e=$(this).parent(),t=e.data("theme");filterCityList("flightClass",this.value,t?t.toLowerCase():null),$(".area_filter label").removeClass("cur"),e.addClass("cur"),trackJson[AppData.route].screen.secondchoose++,trackJson[AppData.route].screen.flightclass=this.value,trackData(AppData.route)}).on("click",".sort_by",function(){var e,t,a=$(this);a.hasClass("cur")||(a.addClass("cur").siblings().removeClass("cur"),a.hasClass("sort_by_price")?(t="totalPrice",e="asc"):(t="hot",e="desc"),sortCityList(t,e),trackJson[AppData.route].screen.hottype=e,trackData(AppData.route))})}function interactWithCityItem(){$(document).on("click",".compare_shadow",function(e){var t=$(this);window.open(t.find('[data-action="booking"]').attr("href"))}),$(document).on("click",".compare_shadow .btn",function(e){e.stopPropagation();var t=$(this),a=t.closest("li").data("category"),i=t.data("action");if("addtocompare"===i&&(e.preventDefault(),addToCompareCities(t.parents(".item").data("sid"),t.parents(".item").data("city"))),"booking"===i||"addtocompare"===i){var r=trackJson[AppData.route][i];r=r||{},r[a]?r[a]++:r[a]=1,trackData(AppData.route)}if("collecting"===i){var o=t.children("i");if(e.preventDefault(),o.hasClass("ico_collection_h")){var n=$(".jump_coll"),s=t.closest(".img").children("img").attr("src");n.find("img").attr("src",s);var c=$("#collection .ico_collection").offset();n.fadeIn().offset(o.offset()).animate({top:c.top,left:c.left},700,function(){n.fadeOut()}),renderUserCollection(t.parents(".item").data("sid"),null,"ADD"),o.removeClass("ico_collection_h").addClass("ico_collectioned")}else o.hasClass("ico_collectioned")&&o.removeClass("ico_collectioned").addClass("ico_collection_h"),renderUserCollection(t.parents(".item").data("sid"),null,"DEL")}}),$(document).on("click",".load-more-city",function(e){e.preventDefault();var t=$(this),a=t.closest("li").prev().data("category");loadMoreCities(t.data("gid"));var i=trackJson[AppData.route].thememodule;i=i||{},i[a]?i[a]++:i[a]=1,trackData("home")}).on("click",".popups-btn",function(){var e=$(this).prev().find("textarea"),t=$.trim(e.val()),a=$(".popups-feedback");t&&$.ajax({url:"/fuzzy/submitComment",type:"POST",data:JSON.stringify({comment:t,uid:window.uid}),dataType:"json",contentType:"application/json; charset=utf-8",beforeSend:function(){a.find("button").text("发送中...")}}).done(function(e){"SUCCESS"===e.questStatus?(a.find("button").text("发送成功"),setTimeout(function(){a.find(".close").trigger("click")},1500)):a.find("button").text(e.message)}).always(function(){setTimeout(function(){a.find("button").text("发送"),e.val("")},2e3)}).error(function(){a.find("button").text("服务器错误")})})}function interactWithSideIcon(){function e(e,r){i(r)?t(e,r):a(e,r)}function t(e,t){e.removeClass("cur"),t.removeClass("open_collection"),$(".mask_layer").addClass("hidden"),$("body").css({overflow:"auto"})}function a(e,t){$(".feedback").hasClass("cur")&&($(".popups-feedback .close").trigger("click"),$(".feedback").removeClass("cur")),$(".collection_tip").hide(),e.addClass("cur"),t.addClass("open_collection"),$(".mask_layer").removeClass("hidden"),$("body").css({overflow:"hidden"})}function i(e){return e[0].className.indexOf("open_collection")>=0}var r=$("#gotoTop"),o=r.find(".gotop");o.goToTop(),r.click(function(e){e.stopPropagation()}),$(window).bind("scroll resize",function(){o.goToTop(),"compare"===AppData.route&&resetCompareSize()}),$(document).click(function(){t($("#gotoTop .collection"),$("#gotoTop"))}),r.on("click","a",function(){var a=$(this);if(a.hasClass("feedback"))$(".collection").hasClass("cur")&&(t($("#gotoTop .collection"),$("#gotoTop")),$(".collectoin").removeClass("cur")),a.toggleClass("cur"),showDialog(),trackJson[AppData.route].comment++,trackData(AppData.route);else if(a.hasClass("his_tit")){if(trackJson[AppData.route].history++,trackData(AppData.route),!searchHistory.length)return;a.toggleClass("cur"),$("#hisList").slideToggle()}else a.hasClass("collection")&&e($(this),$("#gotoTop"))}),$("#collection_box").on("click",".ico_delete",function(e){e.stopPropagation();var t=$(this).closest("ul").find("li").index($(this).closest("li"));removeCollectedIcon(t),renderUserCollection(null,t,"DEL")}).on("click","li",function(e){e.stopPropagation();var t=$(this).index(),a=userCollection[t],i=$.DatePicker.formatDate(new Date(a.departDate),"yyyy-mm-dd"),r=a.returnDate?$.DatePicker.formatDate(new Date(a.returnDate),"yyyy-mm-dd"):"",o=processLink(a.flightClass,a.departCityCode,a.arriveCityCode,i,r,a.travelType);window.open(o+"#ctm_ref=fld_fz_fv_list_p")}),$("#collection_box").on("click",".coll_head .close",function(e){e.stopPropagation(),t($("#gotoTop .collection"),$("#gotoTop"))}),$("#hisList").on("click","li",function(){var e=$(this),t=e.data("searchindex"),a=_.extend({},searchHistory[t]);reflactSearch(a),"search"!==Backbone.history.fragment?appRouter.navigate("search",!0):performSearch(a),trackJson[AppData.route].history_detail++,trackData(AppData.route)})}function removeCollectedIcon(e){var t=AppData.cityData.fuzzyFlightList;if(t&&t.length)for(var a=0;a<t.length;a++)if(t[a].flightResultList&&t[a].flightResultList.length)for(var i=0;i<t[a].flightResultList.length;i++){var r=_.extend({},t[a].flightResultList[i]),o={departCityCode:AppData.address.depart.code||window.departCity,arriveCityCode:r.aCity,departDate:r.flightDetail.departDate,returnDate:r.flightDetail.returnDate,duration:r.flightDetail.duration};if(_.isEqual(_.pick(userCollection[e],["departCityCode","arriveCityCode","departDate","returnDate","duration"]),o)){$(".city_list li").each(function(){$(this).data("sid")===a+","+i&&$(this).find(".ico_collectioned").removeClass("ico_collectioned").addClass("ico_collection_h")});break}}}function showDialog(){var $popups=$(".popups-feedback"),$pm;$popups.length||$(feedbackRender()).hide().prependTo("body"),$popups=$(".popups-feedback, .popups-mask");var ie=eval("!-[1,]");ie?$popups.css({display:"block"}):$popups.fadeIn(200),$popups.off().on("click",".close",function(){ie?$popups.css({display:"none"}):$popups.fadeOut(300),$(".feedback").removeClass("cur")})}function interactWithCompareItem(){$(document).on("click",".btn_find",function(){if("search"!==Backbone.history.fragment?appRouter.navigate("search",!0):performSearch(),location.href.indexOf("?")!==-1){var e=location.href.match(/sid=\d/i),t=location.href.match(/aid=\d/i),a="";window.history.pushState&&(e&&t&&(a="?"+t+"&"+e),location.href.indexOf("#search")!==-1&&(a+="#search"),window.history.pushState({},0,location.href.substring(0,location.href.indexOf("?"))+a))}}),$(".compare ").on("click",".week-to-month",function(){var e=$(this),t=e.data("ym"),a=e.parents("tbody");a.find("tr.week-"+t).hide(),a.find("tr.month-"+t).show(),AppData.$compareListWrapper.customScrollbar("resize",!0)}).on("click",".month-to-week",function(){var e=$(this),t=e.data("ym"),a=e.parents("tbody");a.find("tr.month-"+t).hide(),a.find("tr.week-"+t).show(),AppData.$compareListWrapper.customScrollbar("resize",!0)}),$compare.on("click",".compare_link",function(){compareWrapHidden=!1,toggleCompare(compareCities.length?"show":"hide")}).on("click",".btn-event",function(e){var t=$(this);if(t.hasClass("begin")){if(trackJson[AppData.route].begincompare=1,trackData(AppData.route),!compareCities.length)return;appRouter.navigate("compare",!0),trackJson.compare.citycompare.opencompare++,trackData("compare")}else if(t.hasClass("clear"))removeCompareCity(-1),toggleCompare("clear"),trackJson[AppData.route].cleancomparetime++,trackData(AppData.route);else if(t.hasClass("compare_tit_pack"))appRouter.navigate(Backbone.history.prevFragment,!0);else if(t.hasClass("close"))"compare"===AppData.route&&appRouter.navigate(Backbone.history.prevFragment,!0),compareWrapHidden=!0,toggleCompare("hide");else if(t.hasClass("collaspe"))"compare"===AppData.route&&appRouter.navigate(Backbone.history.prevFragment,!0),toggleCompare("show"),trackJson.compare.citycompare.closecompare++,trackData("compare");else if(t.hasClass("toggle-row")){var a=t.closest("tr"),i=t.find(".month_num").clone();if(!a.hasClass("compare_month_pack"))return void a.prev().find(".arrow_click").trigger("click");a.toggle();var r=a.next(),o=r.find("th"),n=r.find(".month_num");n.length<2&&(o.addClass("btn-event toggle-row"),"ROUNDTRIP"===AppData.searchData.travelType?n.find(".arrow_click").length||n.append(i.find(".arrow_click")):n.before(i)),r.addClass("compare_month_subtitle").find(".arrow_down").addClass("arrow_up").removeClass("arrow_down"),a.nextClosest("tr:not('.compare_month_pack')").toggle(),AppData.$compareListWrapper.customScrollbar("resize",!0),"ROUNDTRIP"!==AppData.searchData.travelType?trackJson.compare.comparelist[a.is(":hidden")?"openmonthprice":"closemonthprice"]++:trackJson.compare.comparelist.outtingday++,trackData("compare")}else if(t.hasClass("btn_buy")){trackJson.compare.comparelist.bookingsoon++;var s=$compare.find(".compare_city").find("li.img").eq(t.data("index")).find("span.like").length;trackJson.compare.comparelist.rec_booking=s?1:0;var c=t.closest(".compare_month_item").find(".compare_month_lowest").length;trackJson.compare.comparelist.lowerprice_booking=c?1:0,trackData("compare")}else t.hasClass("rec_spot")&&(trackJson.compare.comparelist.rec_spot++,trackData("compare"))}).on("click",".compare_city_box .close",function(){
var e=$(this).data("cityId");removeCompareCity(e),trackJson.compare.citycompare.closeciylist++,trackData("compare"),$(this).next().hasClass("like")&&(trackJson.compare.citycompare.isclosereccity=1,trackData("compare"))})}function adjustSorter(){$areaFilter.find("label").removeClass("cur").eq(0).addClass("cur"),$areaFilter.find("input").each(function(e,t){t.checked=!1}),AppData.cityFilter={totalPrice:Number.MAX_VALUE,flightClass:"all"},AppData.citySort=$(".sort_by_price").hasClass("cur")?{totalPrice:"asc"}:{hot:"desc"}}function sortCityList(e,t){function a(e,t,a){var i,r;return"totalPrice"===t&&(i="hot",r="desc"),"hot"===t&&(i="totalPrice",r="asc"),$.each(e.fuzzyFlightList,function(e,o){o.flightResultList.length&&(o.flightResultList=o.flightResultList.sort(function(e,o){return e[t]!=o[t]?"asc"===a?e[t]-o[t]:o[t]-e[t]:"asc"===r?e[i]-o[i]:o[i]-e[i]}))}),e}var i=AppData.cityData,r=AppData.citySort;if(i&&e&&r[e]!==t){for(var o in r)r.hasOwnProperty(o)&&(o!=e&&delete r[o],r[e]=t);a(i,e,t),renderCityList(!1,i)}}function manageSearchText(e,t){var a,i=e;if(i){var r=i.filter;a=i.cities&&i.cities.length?i.cities.join("、"):"",a+=i.areas&&i.areas.length?(a?"、":"")+i.areas.join("、"):"",a+=r&&r.area?(a?"、":"")+r.area:"",a+=i.themes&&i.themes.length?(a?"":"全世界")+"去体验"+i.themes.join("、"):"",a+=r&&r.theme?(~a.indexOf("去体验")?"":"去体验")+r.theme:"",a=a?a:"全世界"}else a="全世界";$(".citi_list_tit").text("为您展示"+t+"飞往"+a+"的热门航班").show()}function performSearch(e){if(e){e=_.extend({},e);var t=new Date,a=Math.round(new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0).getTime());new Date(e.departStartDate)<a&&(delete e.departStartDate,delete e.departEndDate,delete e.minDays,delete e.maxDays,e.departStringDate="任何时间"),AppData.inputArrivalCitiesMap=e.inputArrivalCitiesMap}else e=getArgs();e.minDays&&(e.minDays=parseInt(e.minDays,10)),e.maxDays&&(e.maxDays=parseInt(e.maxDays,10)),e.isSearchPage=!0,$areaFilter.hide();var i=AppData.searchData;i.departStringDate===e.departStringDate&&i.travelType===e.travelType&&i.inputDepartureCity===e.inputDepartureCity||removeCompareCity(-1),AppData.searchData=e,manageSearchText(e.inputArrivalCitiesMap,e.inputDepartureCityName),renderCityList(!0,e).then(function(){AppData.cityData.fuzzyFlightList.length>0&&$(".public_noresult").hide()}),AppData.slider&&AppData.slider.set("value",AppData.slider.size),$compareTip.text(AppData.address.depart.name+"出发到中意的城市对比"),adjustSorter(),renderHistory(e);var r=$.param(_.extend({},{uid:window.uid,page_id:g_page_ids.search},e));window.__bfi.push(["_tracklog","fs.searchhistory",r]),trackJson[AppData.route].search.calendar.day_diff=e.departEndDate&&e.departStartDate?parseInt((new Date(e.departEndDate)-new Date(e.departStartDate))/864e5,10)+1:0,trackData(AppData.route)}function reflactSearch(e){if(e){selectTravelType(e.travelType),AppData.address.depart={name:e.inputDepartureCityName,code:e.inputDepartureCity},$("#homeCity").val(e.inputDepartureCityName?e.inputDepartureCityName:""),AppData.selectDateInfo.start=e.departStartDate?new Date(e.departStartDate):null,AppData.selectDateInfo.end=e.departEndDate?new Date(e.departEndDate):null,selectArrival(e);var t=new Date,a=Math.round(new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0).getTime());new Date(e.departStartDate)<a?$("#date").val("任何时间"):$("#date").val(e.departStringDate?e.departStringDate:"")}}function setupTopBarBG(){if(window.backgroundImg){var e="url("+(window.backgroundImg+"").replace(/^https?:/g,"")+")";$(".topbar").css("background-image",e)}}function setupDepartAddress(){AppData.setupAddress("#homeCity","departAddress").method("bind","change",function(e,t){if(!t.value&&!t.data)return AppData.address.depart=defaultCity,$("#homeCity").val(window.departCityName?window.departCityName:""),void $("#homeCity").blur();var a=/(\S+)\(([A-Z]+)\)/.exec(t.value),i=!1;return $.each(AppData.address&&AppData.address.arrival,function(e,t){if("cities"===t.category&&t.code===a[2])return i=!0,!1}),i?$("#homeCity").blur().val(AppData.address.depart.name?AppData.address.depart.name:""):(AppData.address.depart={code:a[2],name:a[1]},$("#homeCity").blur(),AppData.city_offset=Number(t.data.split("|").pop()),void $arrivalInput.focus())})}function selectTravelType(e){var t;if("string"!=typeof e){t=$(this),e=t.data("val");var a=$dateInput.data("datePicker");if(!a)return;var i=a.$input.val(),r="";"ONEWAY"===e?(r=a.range?i.split(" ")[0]+" 出发":"任何时间",a.$input.val(i+" 出发"),a.switchMode("range_length_acc"===a.mode?"range_length":"range_center")):(r=i.split(" ")[0]+a.valLen(),a.switchMode("range_length"===a.mode?"range_length_acc":"range_center_acc")),a.$input.val(r)}else t=$('a[data-val="'+e+'"]');t.addClass("cur").siblings().removeClass("cur"),$searchForm.find(".search_path_val").text(t.text()),$searchForm.find(".search_path_val").attr("data-select",e)}function selectArrival(e){var t=e.inputArrivalCities,a=e.inputArrivalCitiesMap;AppData.inputTag&&AppData.inputTag.clear(),_.each(t,function(e,t){_.each(e,function(e,i){AppData.inputTag.addItem({category:t,code:e,name:a[t][i]},!0)})}),AppData.address.arrival=AppData.inputTag.tags}function showTip(e,t){var a=$(".tips_box");a.find("span").text(e),a.show(),setTimeout(function(){a.hide()},t||3e3)}function setupArrival(){function e(){AppData.address.arrival.length||t.val("全世界"),i.slideUp("slow"),$searchForm.find(".path_choose").slideUp("fast")}var t=$arrivalInput,a=$dateInput.data("datePicker"),i=$(".search_filter");$searchForm.on("click",".search_item",function(e){var r=$(this);r.hasClass("search_return")&&(i.children().show().end().slideDown(),a&&a.hide(),$searchForm.find(".path_choose").slideUp("fast"),AppData.address.arrival.length||t.val("").attr("placeholder","可输入城市或国家").focus()),r.hasClass("search_path")&&(r.find(".path_choose").slideToggle("fast"),i.slideUp("slow"),a&&a.hide(),trackJson[AppData.route].search.flightwayclick++,trackJson[AppData.route].search.calendar.flightway="ONEWAY"===$(".search_form").find(".search_path_val").attr("data-select")?"S":"D",trackData(AppData.route)),r.hasClass("search_depart")&&($searchForm.find(".path_choose").slideUp("fast"),i.slideUp("slow"),a&&a.hide()),r.hasClass("search_calendar")&&$searchForm.find(".path_choose").slideUp("fast"),e.stopPropagation()}).on("click",".path_choose a",selectTravelType),$(document).on("click",e),$dateInput.on("click",e),i.on("click",function(e){e.stopPropagation()}).on("click","[data-code]",function(){function e(e){var t=trackJson[e];t.search[o]=t.search[o]||{},t.search[o][r]?t.search[o][r]++:t.search[o][r]=1,trackData(e)}var a=$(this),i=a.data("code"),r=a.data("name"),o=a.data("category");return e(AppData.route),"cities"===o&&i===(AppData.address.depart&&AppData.address.depart.code)?void showTip("跟出发地城市相同了"):void t.inputTag("addItem",[{category:o,code:i,name:r},!0])}),AppData.address||(AppData.address={arrival:[]}),AppData.setupAddress("#destCities","arrivalAddress",!0,!0).method("bind","change",function(e,a){if(a&&a.value){var i=/(\S+)\(([A-Z]+)\)/.exec(a.value),r=i?{category:"cities",code:i[2],name:i[1].replace(/\(\S+\)$/,"")}:{category:"areas",name:a.value,code:a.value};return r.code===(AppData.address.depart&&AppData.address.depart.code)?(showTip("跟出发地城市相同了"),t.val("")):void t.inputTag("addItem",[r,!0])}})}function setupDatePicker(){$dateInput.on("init",function(e,t,a){a.find(".cus_days").on("click",".tag",function(){trackJson[AppData.route].search.calendar.outtingday++,trackData(AppData.route)}),a.find(".cus_checkbox").on("click",".date_selected",function(){trackJson[AppData.route].search.calendar.acceptday++,trackData(AppData.route)})}).on("confirm",function(e,t){AppData.selectDateInfo=t.range}).on("keydown",function(e){e.preventDefault(),resetPicker()}).datePicker({start:new Date,end:(new Date).addDays(89),readonly:!1,reflectData:searchRequestModel});$dateInput.data("datePicker")}function resetPicker(){var e=$dateInput.val("任何时间").data("datePicker");e.hide(),e.reset(),AppData.selectDateInfo=[]}function setupSlider(){var e=$(".budget_filter .budget:last"),t=1e4;AppData.slider=$(".price_range").slider({value:t,min:0,max:t,size:t,thumbAlignment:"boundary"}).on("slidechange",function(t,a){var i=0|a.value;i<a.value&&i++,i=i<Math.floor((AppData.maxPrice-AppData.minPrice)/100)?Math.floor((AppData.maxPrice-AppData.minPrice)/100):i,i+=AppData.minPrice,e.html("<dfn>¥</dfn>"+i)}).on("slideend",function(e,t){var a=0|t.value;a<t.value&&a++,a=a<Math.floor((AppData.maxPrice-AppData.minPrice)/100)?Math.floor((AppData.maxPrice-AppData.minPrice)/100):a,a+=AppData.minPrice,filterCityList("totalPrice",a),trackJson[AppData.route].screen.budget=a,trackData(AppData.route)}).data("slider")}function setupUserMenu(){function e(){i&&a&&(t.find(".cui_account").slideUp(),t.find(".icon_arrow").removeClass("icon_arrow_up"))}if(!AppData.$userMenu){var t=AppData.$userMenu=$(".myctrip");window.buildUserMenu=function(e){"F"===e.hascookieuser?(searchHistory=cQuery.storage.get("fuzzy-search-history")||[],renderHistory(),AppData.userLogin=!1):(AppData.userLogin=!0,$.ajax({url:"/fuzzy/getHistory",type:"GET",data:{uid:window.uid},dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){"SUCCESS"===e.historyStatus?_.each(e.data,function(e){e.valueObj=$.deparam(e.value),e.valueObj.inputDepartureCity=e.inputDepartureCity,manageHistory(e.valueObj)}):searchHistory=[],renderHistory()}}))};var a,i;t.on("mouseenter",".links_user",function(e){e.stopPropagation(),a=!1,t.find(".cui_account").slideDown(),t.find(".icon_arrow").addClass("icon_arrow_up")}).on("mouseleave",".links_user",function(t){t.stopPropagation(),a=!0,setTimeout(e,300)}).on("mouseenter",".cui_account",function(e){i=!1,e.stopPropagation()}).on("mouseleave",".cui_account",function(t){i=!0,t.stopPropagation(),setTimeout(e,300)})}$.ajax({url:"https://accounts.ctrip.com/member/ajax/AjaxGetCookie.ashx?jsonp=buildUserMenu&r=0.3130067109595984&encoding=0",dataType:"jsonp"})}function setupUserCollection(){function e(){i&&a&&(t.find(".cui_account").slideUp(),t.find(".icon_arrow").removeClass("icon_arrow_up"))}if(!AppData.$userMenu){var t=AppData.$userMenu=$(".myctrip");window.buildUserMenu=function(e){"F"===e.hascookieuser?(userCollection=cQuery.storage.get("fuzzy-search-user-collection")||[],renderUserCollection(),AppData.userLogin=!1):(AppData.userLogin=!0,$.ajax({url:"/fuzzy/subscribe",type:"POST",data:JSON.stringify({operationType:"RETRIEVE",subscribeDetail:{uid:window.uid}}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){userCollection=e,renderUserCollection()}}))};var a,i;t.on("mouseenter",".links_user",function(e){e.stopPropagation(),a=!1,t.find(".cui_account").slideDown(),t.find(".icon_arrow").addClass("icon_arrow_up")}).on("mouseleave",".links_user",function(t){t.stopPropagation(),a=!0,setTimeout(e,300)}).on("mouseenter",".cui_account",function(e){i=!1,e.stopPropagation()}).on("mouseleave",".cui_account",function(t){i=!0,t.stopPropagation(),setTimeout(e,300)})}$.ajax({url:"https://accounts.ctrip.com/member/ajax/AjaxGetCookie.ashx?jsonp=buildUserMenu&r=0.3130067109595984&encoding=0",dataType:"jsonp"})}function setupCompareTooltip(){var e;$(document).on("mouseenter",'.city_list .btn[data-action="addtocompare"]',function(){compareCities.length<4||(e=$(this).parent().find(".tips_box").show())}).on("mouseleave",'.city_list .btn[data-action="addtocompare"]',function(){compareCities.length<4||e&&e.hide()})}function trackPV(e){window.__bfi.push(["_asynRefresh",{page_id:g_page_ids[e],url:location.href}]),$("#page_id").val(g_page_ids[e])}function manageHistory(e){delete e.recordId,delete e.page_id,delete e.uid,searchHistory.unshift(_.extend({},e)),searchHistory.length>=5&&searchHistory.pop()}function isInHistory(e){var t=!1;return _.each(searchHistory,function(a){_.isEqual(e,a)&&(t=!0)}),t}function renderHistory(e){e?manageHistory(e):null,cQuery.storage.set("fuzzy-search-history",searchHistory),$("#hisList").find("ul").html(historyRender({searchHistory:searchHistory}))}function manageUserCollection(e,t){function a(e){var t=new Date(e),a=["日","一","二","三","四","五","六"],i=(t.getMonth()+1>9?t.getMonth()+1:"0"+(t.getMonth()+1))+"月"+(t.getDate()>9?t.getDate():"0"+t.getDate())+"日",r="周"+a[t.getDay()];return i+" "+r}if(e||0===e)if(_.isNumber(e))AppData.userLogin&&$.ajax({url:"/fuzzy/subscribe",type:"POST",data:JSON.stringify({operationType:"DELETE",subscribeDetail:{uid:window.uid,createDate:userCollection[e].createDate}}),dataType:"json",contentType:"application/json; charset=utf-8"}),removeCollectedIcon(e),userCollection.splice(e,1);else{for(var i=0;i<userCollection.length;i++){var r=["departCityCode","arriveCityCode","departDate","returnDate","duration"];if(_.isEqual(_.pick(e,r),_.pick(userCollection[i],r))){AppData.userLogin&&!function(){$.ajax({url:"/fuzzy/subscribe",type:"POST",data:JSON.stringify({operationType:"DELETE",subscribeDetail:{uid:window.uid,createDate:userCollection[i].createDate}}),dataType:"json",contentType:"application/json; charset=utf-8"})}(userCollection[i]),"DEL"===t&&removeCollectedIcon(i),userCollection.splice(i,1);break}}if("ADD"===t){var o=[];o.push(e),addCollectedIcon(o),e=_.extend(e,{uid:window.uid}),e.departDateDisplay=a(e.departDate),e.roundDateDisplay=a(e.returnDate),userCollection.unshift(e),userCollection.length>20&&(removeCollectedIcon(20),userCollection.pop()),AppData.userLogin&&$.ajax({url:"/fuzzy/subscribe",type:"POST",data:JSON.stringify({operationType:"CREATE",subscribeDetail:e}),dataType:"json",contentType:"application/json; charset=utf-8"})}}else _.each(userCollection,function(e){e.departDateDisplay=a(e.departDate),e.roundDateDisplay=e.returnDate?a(e.returnDate):""})}function renderUserCollection(e,t,a){function i(){userCollection&&userCollection.length&&$.ajax({url:"/fuzzy/recommendedSpotSearch",type:"POST",data:JSON.stringify(_.pluck(userCollection,"arriveCityName")),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){_.each(userCollection,function(t){t.recommendSpot=_.pluck(e[t.arriveCityName],"poiName")}),$("#collection_box").find("li").each(function(e){var t=$(this).find(".flt_tags");_.each(userCollection[e].recommendSpot,function(e){t.append('<span class="tag">'+e+"</span>")})})}})}function r(e){if(userCollection&&userCollection.length){var t=[],a={};_.each(userCollection,function(e){t.push({dCity:e.departCityCode,aCity:e.arriveCityCode,travelType:e.travelType,departDateRange:{startDate:$.DatePicker.formatDate(new Date(e.departDate),"yyyy-mm-dd"),endDate:e.returnDate?$.DatePicker.formatDate(new Date(e.returnDate),"yyyy-mm-dd"):null},duration:e.duration})}),a={header:{channelId:"ONLINE",sourceAppId:"100001983",clientId:"100001983"},isIncludedTax:!0,airRouteList:t},$.ajax({url:"/fuzzy/fetchSubscribedLatestPrice",type:"POST",data:JSON.stringify(a),dataType:"json",contentType:"application/json; charset=utf-8",success:function(t){var a=0;$("#collection_box").find("li").each(function(e){var i=$.DatePicker.formatDate(new Date(userCollection[e].departDate),"yyyy-mm-dd"),r=userCollection[e].returnDate?$.DatePicker.formatDate(new Date(userCollection[e].returnDate),"yyyy-mm-dd"):"",o="fs_ar_"+userCollection[e].travelType+":"+userCollection[e].departCityCode+"-"+userCollection[e].arriveCityCode+":"+i;if(r&&(o+=":"+r),t[o]){var n=userCollection[e].originalPrice-t[o].totalPrice;n>0&&(a++,$(this).find(".price .val").text(t[o].totalPrice),$(this).append('<div class="news_tip">比收藏时降价<dfn>¥</dfn>'+n+"</div>"))}}),a&&"DEL"!==e&&"ADD"!==e&&$(".collection_tip").show()}})}}var o,n={};if(e){var s=(""+e).split(",");o=_.extend({},AppData.cityData.fuzzyFlightList[s[0]].flightResultList[s[1]]),n={departCityCode:AppData.address.depart.code||window.departCity,departCityName:AppData.address.depart.name||window.departCityName,arriveCityCode:o.aCity,arriveCityName:o.aCityName,travelType:getTravelType(),departDate:o.flightDetail.departDate,returnDate:o.flightDetail.returnDate,duration:o.flightDetail.duration,flightClass:o.flightClass,originalPrice:o.totalPrice,isNonstop:null},"ADD"===a&&(n.createDate=(new Date).getTime()),manageUserCollection(n,a)}null!==t&&a&&manageUserCollection(t,a),e||t||a||manageUserCollection(),cQuery.storage.set("fuzzy-search-user-collection",userCollection),$("#collection_box").html(userCollectionRender({userCollection:userCollection})),i(),r(a)}function processLink(e,t,a,i,r,o){var n="//flights.ctrip.com/",s="D"!==e,c=o,p="ROUNDTRIP"===c;return s?(n+="international/search/"+(p?"round":"oneway")+"-"+(t+"-"+a).toLowerCase()+"?depdate="+i+(r?"_"+r:""),n+="&sort=price_asc"):(n+="booking/"+t+"-"+a,n+="ONEWAY"===c?".html?DDate1="+i:"/?ddate1="+i+(r?"&ddate2="+r:""),n+="&SortByPrice=true"),n+"&a=b"}$.fn.nextClosest=function(e){for(var t=this.next(),a=t;t.is(e)&&(a=a.add(t),t=t.next(),t.is(e)););return a};var xhr;"string"==typeof window.departCity&&(window.departCity=decodeURIComponent(window.departCity),window.departCityName=decodeURIComponent(window.departCityName));var defaultCity={code:window.departCity,name:window.departCityName},g_page_ids={home:"600003793",search:"600003794",compare:"600003795"},g_page_keys={home:"flt_vague_search_homepage",search:"flt_vague_search_searchresult",compare:"flt_vague_search_citycompare"},imageSetting={big:"582",middle:"284",small:"268"},iconSetting={HaiDaoShaTan:{name:"海岛沙滩",value:"2"},TaoKeShengYan:{name:"饕客盛宴",value:"4"},FengKuangXuePin:{name:"疯狂血拼",value:"3"},LiShiWenHua:{name:"历史文化",value:"6"},MianQianLuoDiQian:{name:"免签/落地签",value:"1"},MingShanCaoYuan:{name:"名山草原",value:"7"},JiaTingQinZi:{name:"家庭亲子",value:"11"},JiXianTanXian:{name:"极限探险",value:"9"},DongJiNuanTang:{name:"冬季暖汤",value:"13"},ShangHuaYueRen:{name:"赏花悦人",value:"14"},LangManQingDiao:{name:"浪漫情调",value:"15"},DiYiCiChuJing:{name:"第一次出境",value:"16"},ShuQiDang:{name:"暑期档",value:"10"},XueShengDang:{name:"学生党",value:10},ChunJieChuYou:{name:"春节出游",value:17},HuiJiaGuoNian:{name:"回家过年",value:18}},categoryMap={D:"国内",I:"国际/地区"},countryColorsSetting={1:7,2:10,3:12,4:14,5:15},indexJson={search:{themes:{},areas:{},cities:{},calendar:{flightway:"",month:0,year:0,holiday:{},day_diff:0,outtingday:0,acceptday:0},flightwayclick:0},screen:{hottype:"desc",budget:100,flightclass:"",secondchoose:0},thememodule:{},booking:{},addtocompare:{},cleancomparetime:0,begincompare:0,comment:0,history:0,history_detail:0,timetips:0},trackJson={home:indexJson,search:_.extend({},indexJson),compare:{citycompare:{closecompare:0,opencompare:0,closeciylist:0,isclosereccity:0},comparelist:{openmonthprice:0,closemonthprice:0,bookingsoon:0,rec_booking:0,lowerprice_booking:0,outtingday:0,rec_spot:0}}},flags={},compareCities=[],compareCityCache={},compareWrapHidden=!0,searchHistory=[],userCollection=[],$cityListContainer=$(".city-list-container"),$loader=$(".public_loading"),$compare=$(".compare_fixed"),$compareCitiesContainer=$(".compare .compare_city"),compareCitiesRender=_.template($("#tpl-compare-cities").html()),$areaFilter=$(".area_filter"),$hotSortEl=$(".hot_filter"),$priceSortEl=$(".price_filter"),$compareTip=$(".compare .compare_tit .txt"),$dateInput=$("#date"),$arrivalInput=$("#destCities"),$compareWrap=$(".compare .compare_wrap"),$searchForm=$(".search_form"),cityListRender=_.template($("#tpl-city-list").html()),feedbackRender=_.template($("#tpl-feedback").html()),historyRender=_.template($("#tpl-history").html()),userCollectionRender=_.template($("#tpl-collection").html());resetInit();var routeActions={compareIn:function(){$(document.body).css("overflow","hidden"),toggleCompare("expand");var e=$(window).height();$compareWrap.css("height",e),$("#gotoTop").hide(),AppData.compareListRender?resetCompareSize():(AppData.$compareListContainer=$("#compare_table_scroll"),AppData.$compareListWrapper=AppData.$compareListContainer.parent().parent(),AppData.compareListRender=_.template($("#tpl-compare-list").html()),AppData.$compareListWrapper.css({height:e-175}).customScrollbar({skin:"gray-skin",hScroll:!1}));var t=_.extend({},AppData.searchData);delete t.inputArrivalCities,delete t.inputArrivalCitiesMap,delete t.isSearchPage;var a={inputArrivalCities:_.map(compareCities,function(e){return{aCity:e.aCity,flightClass:e.flightClass}})};_.extend(a,t),renderCompareList(!0,a)},compareOut:function(){$(document.body).css("overflow","visible"),$(".compare").removeClass("expand"),$("#gotoTop").show()},searchIn:function(){performSearch()},searchOut:function(){$priceSortEl.hide()},homeIn:function(){adjustSorter(),$dateInput.val("任何时间");var e=$dateInput.data("datePicker");e&&e.reset(),$arrivalInput.val("全世界"),AppData.inputTag&&AppData.inputTag.clear()}},searchRequestModel=window.searchRequestModel?JSON.parse(decodeURIComponent(window.searchRequestModel)):null;!searchRequestModel||searchRequestModel.inputDepartureCity||searchRequestModel.inputDepartureCityName||(searchRequestModel.inputDepartureCity=window.departCity,searchRequestModel.inputDepartureCityName=window.departCityName);var Router=Backbone.Router.extend({routes:{"":"home",search:"search",compare:"compare","*notFound":"home"},home:function(){if(AppData.route="home",trackPV("home"),AppData.inputArrivalCitiesMap={},selectArrival({inputArrivalCities:{},inputArrivalCitiesMap:{}}),routeCheck()){if((routeActions.homeIn||$.noop)(),toggleFiltersSort("hide"),$(".filter_bar").find(".budget_filter").css("border-left",0),AppData.enterSearchPage=!1,searchRequestModel){var e=searchRequestModel.departStringDate;e&&"任何时间"!==e&&(AppData.enterSearchPage=!0);for(var t in searchRequestModel.inputArrivalCities)if(searchRequestModel.inputArrivalCities.hasOwnProperty(t)&&searchRequestModel.inputArrivalCities[t].length>0){AppData.enterSearchPage=!0;break}}searchRequestModel&&AppData.enterSearchPage&&"search"!==Backbone.history.prevFragment?appRouter.navigate("search",!0):getCityInit(),searchRequestModel&&AppData.enterSearchPage||$(".search_filter").children(":not(.row_topic)").hide().end().slideDown()}},search:function(){if(toggleFiltersSort("show"),$(".filter_bar").find(".budget_filter").css("border-left","1px solid #d9d9d9"),AppData.route="search",trackPV("search"),routeCheck()){if(searchRequestModel){if(/#search/.test(location.href)&&(AppData.enterSearchPage=!0),/roundtrip/i.test(searchRequestModel.travelType)&&(searchRequestModel.mode="range_length_acc"),AppData.inputArrivalCitiesMap=searchRequestModel.inputArrivalCitiesMap||{},!AppData.enterSearchPage)return AppData.address.depart.name||(AppData.inputArrivalCitiesMap={}),void performSearch();var e={inputDepartureCity:defaultCity.code,inputDepartureCityName:defaultCity.name,isSearchPage:!0,travelType:"ONEWAY",departStringDate:"任何时间"};return searchRequestModel.inputDepartureCity=searchRequestModel.inputDepartureCity.toUpperCase(),AppData.searchData=_.extend({},e,searchRequestModel),reflactSearch(AppData.searchData),void performSearch(AppData.searchData)}!AppData.address.depart.name,performSearch()}},compare:function(){return AppData.cityData&&compareCities.length?(AppData.route="compare",trackPV("compare"),void(routeActions.compareIn||$.noop)()):appRouter.navigate(Backbone.history.prevFragment||"",!0)}}),appRouter=new Router;Backbone.history.start({pushState:!1,hashChange:!0}),$(function(){init()})}(jQuery,_,window.AppData||(window.AppData={}));